<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KeremAI v10 - Secure</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- Temel Ayarlar --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        :root {
            --bg: #09090b; --sidebar: #121214; --input-bg: #1e1e20;
            --text: #e4e4e7; --accent: #3b82f6; 
            --grad: linear-gradient(135deg, #3b82f6, #8b5cf6);
            --code-bg: #18181b;
        }
        body { 
            margin: 0; background: var(--bg); color: var(--text); 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            display: flex; height: 100vh; height: 100dvh; overflow: hidden;
        }

        /* --- G√úVENLƒ∞K EKRANI (LOGIN) --- */
        #loginOverlay {
            position: fixed; inset: 0; background: #000000; z-index: 9999;
            display: flex; align-items: center; justify-content: center; flex-direction: column;
        }
        .login-box {
            background: #18181b; padding: 40px; border-radius: 24px; border: 1px solid #27272a;
            text-align: center; width: 90%; max-width: 400px;
            box-shadow: 0 0 50px rgba(59, 130, 246, 0.1);
        }
        .login-title {
            font-size: 24px; font-weight: 800; background: var(--grad);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 20px;
        }
        .login-input {
            width: 100%; padding: 14px; background: #09090b; border: 1px solid #27272a;
            color: white; border-radius: 12px; margin-bottom: 20px; font-size: 16px; text-align: center; letter-spacing: 2px;
        }
        .login-input:focus { border-color: var(--accent); box-shadow: 0 0 15px rgba(59, 130, 246, 0.2); }
        .login-btn {
            width: 100%; padding: 14px; background: var(--grad); color: white; border: none;
            border-radius: 12px; font-weight: bold; font-size: 16px; cursor: pointer; transition: 0.2s;
        }
        .login-btn:hover { opacity: 0.9; transform: scale(1.02); }
        .error-msg { color: #ef4444; font-size: 13px; margin-top: 15px; display: none; }

        /* --- Sidebar --- */
        .sidebar { 
            width: 280px; background: var(--sidebar); display: flex; flex-direction: column; 
            padding: 16px; border-right: 1px solid #27272a; z-index: 100;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .brand { 
            font-size: 20px; font-weight: 800; background: var(--grad); 
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; 
            margin-bottom: 24px; display: flex; justify-content: space-between; align-items: center; 
        }
        .close-sidebar { display: none; background: none; border: none; color: #71717a; font-size: 20px; }
        .new-chat { 
            background: #27272a; color: #a1a1aa; padding: 12px; border-radius: 12px; cursor: pointer; 
            display: flex; align-items: center; gap: 10px; font-size: 14px; border: 1px solid #3f3f46; margin-bottom: 12px; transition: 0.2s; 
        }
        .new-chat:hover { background: #3f3f46; color: white; border-color: #52525b; }
        .history { flex-grow: 1; overflow-y: auto; margin-top: 10px; padding-right: 5px; }
        .h-item { 
            padding: 10px 12px; border-radius: 8px; cursor: pointer; font-size: 13px; color: #a1a1aa; 
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; 
            border: 1px solid transparent; transition: 0.1s;
        }
        .h-item:hover { background: #27272a; color: white; }
        .h-item.active { background: #1e1e24; color: white; border-color: #3f3f46; border-left: 3px solid var(--accent); }
        .h-title { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 150px; }
        .h-actions { display: flex; gap: 5px; opacity: 0; }
        .h-item:hover .h-actions { opacity: 1; }
        .action-btn { background: none; border: none; color: #71717a; font-size: 12px; padding: 4px; cursor: pointer; }
        .action-btn:hover { color: white; }
        .settings-btn { 
            margin-top: auto; padding: 12px; background: #18181b; border-radius: 10px; 
            cursor: pointer; text-align: center; border: 1px solid #27272a; 
            font-size: 13px; color: #a1a1aa; display: flex; align-items: center; justify-content: center; gap: 8px;
        }

        /* --- Ana Alan --- */
        .main { flex-grow: 1; display: flex; flex-direction: column; position: relative; width: 100%; }
        .header { 
            padding: 0 16px; border-bottom: 1px solid #27272a; display: flex; 
            align-items: center; gap: 12px; background: var(--bg); height: 64px;
        }
        .menu-btn { display: none; background: none; border: none; color: white; font-size: 20px; }
        .modes { display: flex; gap: 4px; background: #18181b; padding: 4px; border-radius: 10px; border: 1px solid #27272a; }
        .mode-opt { padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; color: #71717a; font-weight: 500; transition: 0.2s;}
        .mode-opt.active { background: #27272a; color: white; box-shadow: 0 1px 2px rgba(0,0,0,0.2); }

        /* Sohbet */
        .chat-area { flex-grow: 1; padding: 24px 15%; overflow-y: auto; display: flex; flex-direction: column; gap: 24px; scroll-behavior: smooth; }
        .msg { display: flex; gap: 16px; font-size: 15px; line-height: 1.6; max-width: 100%; }
        .msg.user { flex-direction: row-reverse; }
        .avatar { width: 36px; height: 36px; border-radius: 10px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-size: 16px; }
        .avatar.ai { background: var(--grad); color: white; }
        .avatar.user { background: #27272a; color: #e4e4e7; border: 1px solid #3f3f46; }
        .bubble { max-width: 100%; position: relative; word-wrap: break-word; }
        .msg.user .bubble { background: #27272a; color: white; padding: 12px 18px; border-radius: 16px; border-bottom-right-radius: 2px; }
        .msg.ai .bubble { padding-left: 0; width: 100%; }
        .bubble img { max-width: 100%; border-radius: 8px; margin-top: 8px; border: 1px solid #3f3f46; }
        .bubble pre { background: var(--code-bg); padding: 16px; border-radius: 8px; overflow-x: auto; margin: 16px 0; border: 1px solid #27272a; position: relative; font-family: 'Consolas', monospace; }
        .copy-btn { 
            position: absolute; top: 12px; right: 12px; background: rgba(255,255,255,0.05); color: #a1a1aa; 
            border: 1px solid #3f3f46; border-radius: 6px; padding: 6px 10px; font-size: 11px; 
            cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 6px;
        }
        .copy-btn:hover { background: rgba(255,255,255,0.1); color: white; }
        .typing-cursor::after { content: '‚ñã'; display: inline-block; animation: blink 1s infinite; color: var(--accent); margin-left: 2px; font-size: 0.8em;}
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }

        /* Input */
        .input-area { padding: 16px 15%; background: var(--bg); display: flex; flex-direction: column; gap: 12px; border-top: 1px solid #27272a; }
        .img-preview { display: none; padding: 8px; background: #18181b; border-radius: 8px; width: fit-content; position: relative; border: 1px solid #27272a; }
        .img-preview img { height: 60px; border-radius: 4px; }
        .close-img { position: absolute; top: -8px; right: -8px; background: #ef4444; color: white; border: none; border-radius: 50%; width: 22px; height: 22px; cursor: pointer; }
        .input-box { background: var(--input-bg); border-radius: 24px; padding: 12px 20px; display: flex; align-items: center; gap: 12px; border: 1px solid #27272a; transition: border 0.2s; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .input-box:focus-within { border-color: #52525b; background: #27272a; }
        input[type="text"] { flex-grow: 1; background: none; border: none; color: white; font-size: 16px; padding: 0; }
        .icon-btn { background: none; border: none; color: #71717a; font-size: 20px; cursor: pointer; padding: 4px; transition: 0.2s; }
        .icon-btn:hover { color: var(--accent); }

        /* Modal */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 2000; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
        .modal { background: #18181b; padding: 32px; border-radius: 20px; width: 90%; max-width: 480px; border: 1px solid #27272a; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); }
        .form-label { display: block; color: #a1a1aa; font-size: 13px; margin-bottom: 8px; }
        .form-control { width: 100%; padding: 12px; background: #09090b; border: 1px solid #27272a; color: white; border-radius: 8px; margin-bottom: 20px; font-size: 14px; }
        .btn { width: 100%; padding: 14px; border-radius: 10px; border: none; cursor: pointer; font-weight: 600; transition: 0.2s; }
        .btn-save { background: var(--grad); color: white; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.25); }

        @media (max-width: 768px) {
            .sidebar { position: fixed; left: -100%; top: 0; height: 100%; width: 85%; }
            .sidebar.active { left: 0; box-shadow: 100px 0 0 rgba(0,0,0,0.5); }
            .menu-btn { display: block; } .close-sidebar { display: block; }
            .overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 90; }
            .overlay.active { display: block; }
            .chat-area, .input-area { padding-left: 20px; padding-right: 20px; }
        }
    </style>
</head>
<body>

<div id="loginOverlay">
    <div class="login-box">
        <div class="login-title">KeremAI Secure</div>
        <input type="password" id="sysPass" class="login-input" placeholder="≈ûƒ∞FREYƒ∞ Gƒ∞Rƒ∞Nƒ∞Z">
        <button class="login-btn" onclick="checkLogin()">Sƒ∞STEMƒ∞ A√á</button>
        <div id="loginError" class="error-msg">‚õî Eri≈üim Reddedildi: Yanlƒ±≈ü ≈ûifre</div>
    </div>
</div>

<div class="overlay" onclick="toggleSidebar()"></div>

<div class="sidebar" id="sidebar">
    <div class="brand">
        KeremAI <span style="font-size:11px; padding:4px 8px; background:#27272a; border-radius:6px; color:#a1a1aa;">v10</span>
        <button class="close-sidebar" onclick="toggleSidebar()"><i class="fa-solid fa-xmark"></i></button>
    </div>
    <div class="new-chat" onclick="ChatManager.newChat(); toggleSidebar()">
        <i class="fa-solid fa-plus"></i> Yeni Sohbet
    </div>
    <div class="history" id="historyList"></div>
    <div class="settings-btn" onclick="UIManager.openModal()">
        <i class="fa-solid fa-sliders"></i> API Ayarlarƒ±
    </div>
</div>
<div class="main">
    <div class="header">
        <button class="menu-btn" onclick="toggleSidebar()"><i class="fa-solid fa-bars"></i></button>
        <div class="modes">
            <div class="mode-opt active" onclick="ChatManager.setMode('hizli', this)"><i class="fa-solid fa-bolt"></i> Hƒ±zlƒ±</div>
            <div class="mode-opt" onclick="ChatManager.setMode('pro', this)"><i class="fa-solid fa-wand-magic-sparkles"></i> Pro</div>
            <div class="mode-opt" onclick="ChatManager.setMode('dusunen', this)"><i class="fa-solid fa-brain"></i> D√º≈ü√ºnen</div>
        </div>
        <div id="activeModelDisplay" style="margin-left:auto; font-size:12px; color:#52525b;"></div>
    </div>

    <div class="chat-area" id="chatArea">
        <div style="text-align: center; margin-top: 30vh; opacity: 0.6; transform: translateY(-20px);">
            <h1 style="background: var(--grad); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-size:42px; margin:0 0 10px 0;">KeremAI</h1>
            <p style="color:#a1a1aa;">G√ºvenli Sistem Aktif</p>
        </div>
    </div>

    <div class="input-area">
        <div class="img-preview" id="imgPreview">
            <img id="previewEl" src="">
            <button class="close-img" onclick="ImageManager.clear()"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div class="input-box">
            <label class="icon-btn" title="Resim Ekle">
                <input type="file" hidden accept="image/*" onchange="ImageManager.handleSelect(this)">
                <i class="fa-regular fa-image"></i>
            </label>
            <input type="text" id="userInput" placeholder="Mesaj yaz..." autocomplete="off">
            <button class="icon-btn" id="sendBtn" style="color:var(--accent);" onclick="ChatManager.sendMessage()">
                <i class="fa-solid fa-paper-plane"></i>
            </button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="settingsModal">
    <div class="modal">
        <h2 style="margin-top:0; font-size:20px;">‚öôÔ∏è API Baƒülantƒ±sƒ±</h2>
        <label class="form-label">Saƒülayƒ±cƒ±</label>
        <select id="providerSel" class="form-control" onchange="APIManager.uiCheck()">
            <option value="google">Google Gemini</option>
            <option value="openai">OpenAI (GPT)</option>
            <option value="openrouter">OpenRouter (Hepsi)</option>
        </select>
        <label class="form-label">API Anahtarƒ±</label>
        <div style="display:flex; gap:10px; margin-bottom:20px;">
            <input type="password" id="apiKeyInp" class="form-control" style="margin-bottom:0;" placeholder="sk-..." oninput="APIManager.detectProvider()">
            <button class="btn btn-save" style="width:auto; padding:0 20px; background:#27272a; border:1px solid #3f3f46;" id="scanBtn" onclick="APIManager.scanModels()">üîç</button>
        </div>
        <div id="scanMsg" style="font-size:12px; margin-top:-10px; margin-bottom:15px; min-height:18px;"></div>
        <label class="form-label">Model Se√ßimi</label>
        <select id="modelSel" class="form-control"><option value="" disabled selected>√ñnce tarama yapƒ±n...</option></select>
        <div id="baseUrlGroup" style="display:none;">
            <label class="form-label">Base URL</label>
            <input type="text" id="baseUrlInp" class="form-control" placeholder="https://openrouter.ai/api/v1">
        </div>
        <button class="btn btn-save" onclick="APIManager.saveConfig()">Kaydet</button>
        <button class="btn" style="background:transparent; color:#a1a1aa; margin-top:0;" onclick="UIManager.closeModal()">Vazge√ß</button>
    </div>
</div>

<script>
    // --- G√úVENLƒ∞K Sƒ∞STEMƒ∞ ---
    const SECURITY = {
        pass: "Eemkmsss√∂L≈üpsMNA12",
        check: () => {
            const inp = document.getElementById('sysPass');
            const err = document.getElementById('loginError');
            if(inp.value === SECURITY.pass) {
                document.getElementById('loginOverlay').style.display = 'none';
                ChatManager.init(); // Sistemi ba≈ülat
            } else {
                err.style.display = 'block';
                inp.value = '';
                inp.focus();
            }
        }
    };
    function checkLogin() { SECURITY.check(); }
    document.getElementById('sysPass').addEventListener("keypress", (e)=>{if(e.key==="Enter") checkLogin();});

    // --- Sƒ∞STEM KODLARI ---
    function toggleSidebar() { document.getElementById('sidebar').classList.toggle('active'); document.querySelector('.overlay').classList.toggle('active'); }

    const State = {
        chats: JSON.parse(localStorage.getItem('keremai_v10_chats')) || [],
        activeChatId: null,
        savedModels: JSON.parse(localStorage.getItem('keremai_v10_models')) || [], 
        config: JSON.parse(localStorage.getItem('keremai_v10_config')) || { provider: 'google', key: '', model: '', baseUrl: '' },
        currentMode: 'hizli', currentImg: null, isTyping: false
    };

    const Prompts = {
        hizli: "Sen KeremAI'sƒ±n. T√ºrk√ße konu≈ü. En kƒ±sa, net ve doƒürudan cevabƒ± ver.",
        pro: "Sen KeremAI'sƒ±n. √úst d√ºzey bir yapay zeka asistanƒ±sƒ±n. Markdown formatƒ±nda (kalƒ±n, liste, kod bloƒüu) detaylƒ± ve profesyonel cevaplar ver.",
        dusunen: "Sen KeremAI'sƒ±n. [DERƒ∞N ANALƒ∞Z] modundasƒ±n. Soruyu adƒ±m adƒ±m d√º≈ü√ºn. Mantƒ±ksal analiz yap. Kod yazƒ±yorsan en g√ºvenli ve modern y√∂ntemi se√ß. Sadece sonucu m√ºkemmel ≈üekilde ver."
    };

    const ImageManager = {
        handleSelect: (input) => {
            const file = input.files[0]; if(!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                State.currentImg = { base64: e.target.result.split(',')[1], mime: file.type, full: e.target.result };
                document.getElementById('previewEl').src = e.target.result;
                document.getElementById('imgPreview').style.display = 'block';
            };
            reader.readAsDataURL(file);
        },
        clear: () => { State.currentImg = null; document.getElementById('imgPreview').style.display = 'none'; }
    };

    const APIManager = {
        detectProvider: () => {
            const k = document.getElementById('apiKeyInp').value; const sel = document.getElementById('providerSel');
            if(k.startsWith('AIza')) sel.value = 'google'; else if(k.startsWith('sk-or')) sel.value = 'openrouter'; else if(k.startsWith('sk-')) sel.value = 'openai';
            APIManager.uiCheck();
        },
        uiCheck: () => { document.getElementById('baseUrlGroup').style.display = document.getElementById('providerSel').value === 'openrouter' ? 'block' : 'none'; },
        scanModels: async () => {
            const k = document.getElementById('apiKeyInp').value; const p = document.getElementById('providerSel').value;
            const m = document.getElementById('scanMsg'); const sel = document.getElementById('modelSel'); const btn = document.getElementById('scanBtn');
            const base = document.getElementById('baseUrlInp').value || 'https://openrouter.ai/api/v1';

            if(!k) return m.innerText = "‚ùå L√ºtfen anahtar girin";
            m.innerText = "Baƒülanƒ±yor..."; btn.disabled=true;

            try {
                let list = [];
                if(p === 'google') {
                    const r = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${k}`);
                    const d = await r.json(); if(d.error) throw new Error(d.error.message);
                    list = d.models.filter(x=>x.supportedGenerationMethods.includes("generateContent")).map(x=>({id:x.name.replace('models/',''), name:x.displayName||x.name}));
                } else {
                    const u = p === 'openai' ? 'https://api.openai.com/v1/models' : `${base}/models`;
                    const r = await fetch(u, { headers: { 'Authorization': `Bearer ${k}` } });
                    const d = await r.json(); if(d.error) throw new Error(d.error.message);
                    const data = d.data || d; list = data.map(x=>({id:x.id, name:x.name||x.id})).sort((a,b)=>a.id.localeCompare(b.id));
                }
                State.savedModels = list; localStorage.setItem('keremai_v10_models', JSON.stringify(list));
                APIManager.populateModelSelect(list);
                m.innerText = `‚úÖ ${list.length} model bulundu`; m.style.color="#4ade80";
            } catch(e) { m.innerText = "Hata: " + e.message; m.style.color="#ef4444"; } finally { btn.disabled=false; }
        },
        populateModelSelect: (list) => {
            const sel = document.getElementById('modelSel'); sel.innerHTML = '';
            list.forEach(x=>{ const o=document.createElement('option'); o.value=x.id; o.innerText=x.name; sel.appendChild(o); });
            if(State.config.model) sel.value = State.config.model;
        },
        saveConfig: () => {
            State.config = { provider: document.getElementById('providerSel').value, key: document.getElementById('apiKeyInp').value, model: document.getElementById('modelSel').value, baseUrl: document.getElementById('baseUrlInp').value };
            localStorage.setItem('keremai_v10_config', JSON.stringify(State.config));
            UIManager.closeModal(); ChatManager.init();
        },
        generate: async (hist, txt, img) => {
            const {provider, key, model, baseUrl} = State.config;
            const sys = Prompts[State.currentMode];
            if(provider === 'google') {
                const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${key}`;
                let conts = hist.map(m=>({ role: m.role==='ai'?'model':'user', parts:[{text:m.content}] }));
                const curr = [{text:txt}]; if(img) curr.push({ inlineData: { mimeType:img.mime, data:img.base64 } });
                if(conts.length===0) curr[0].text = sys + "\n\n" + txt; else conts[0].parts[0].text = sys + "\n\n" + conts[0].parts[0].text;
                conts.push({ role:'user', parts:curr });
                const r = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({contents:conts}) });
                const d = await r.json(); if(d.error) throw new Error(d.error.message); return d.candidates[0].content.parts[0].text;
            } else {
                const u = provider==='openai'?'https://api.openai.com/v1/chat/completions':`${baseUrl}/chat/completions`;
                let msgs = [{role:"system", content:sys}];
                hist.forEach(m=>msgs.push({role:m.role==='ai'?'assistant':'user', content:m.content}));
                let uCont = txt; if(img) uCont = [{type:"text", text:txt}, {type:"image_url", image_url:{url:img.full}}];
                msgs.push({role:"user", content:uCont});
                const h = {'Authorization':`Bearer ${key}`, 'Content-Type':'application/json'};
                if(provider==='openrouter'){ h['HTTP-Referer']=window.location.href; h['X-Title']='KeremAI'; }
                const r = await fetch(u, { method:'POST', headers:h, body:JSON.stringify({model, messages:msgs}) });
                const d = await r.json(); if(d.error) throw new Error(d.error.message); return d.choices[0].message.content;
            }
        }
    };

    const ChatManager = {
        init: () => {
            UIManager.renderSidebar();
            if(State.chats.length>0) ChatManager.loadChat(State.chats[0].id); else ChatManager.newChat();
            if(State.config.key) {
                document.getElementById('apiKeyInp').value = State.config.key;
                document.getElementById('providerSel').value = State.config.provider;
                document.getElementById('baseUrlInp').value = State.config.baseUrl;
                if(State.savedModels.length > 0) APIManager.populateModelSelect(State.savedModels);
                else if (State.config.model) { const o=document.createElement('option'); o.value=State.config.model; o.innerText=State.config.model; document.getElementById('modelSel').appendChild(o); document.getElementById('modelSel').value=State.config.model; }
                if(State.config.model) document.getElementById('activeModelDisplay').innerText = `Model: ${State.config.model}`;
                APIManager.uiCheck();
            }
        },
        newChat: () => { const c = { id:Date.now(), title:'Yeni Sohbet', messages:[] }; State.chats.unshift(c); ChatManager.save(); ChatManager.loadChat(c.id); },
        loadChat: (id) => { State.activeChatId = id; UIManager.renderChat(State.chats.find(c=>c.id===id)); UIManager.renderSidebar(); },
        renameChat: (e, id) => { e.stopPropagation(); const t = prompt("Adƒ±:"); if(t){State.chats.find(c=>c.id===id).title=t; ChatManager.save(); UIManager.renderSidebar();} },
        deleteChat: (e, id) => { e.stopPropagation(); if(confirm("Silmek istediƒüine emin misin?")){State.chats=State.chats.filter(c=>c.id!==id); ChatManager.save(); if(State.chats.length>0) ChatManager.loadChat(State.chats[0].id); else ChatManager.newChat();} },
        sendMessage: async () => {
            if(State.isTyping) return;
            const txt = document.getElementById('userInput').value.trim();
            const img = State.currentImg;
            if(!txt && !img) return;
            if(!State.config.key) return UIManager.openModal();

            const chat = State.chats.find(c=>c.id===State.activeChatId);
            UIManager.appendMsg('user', txt, img?img.full:null);
            document.getElementById('userInput').value = ''; ImageManager.clear();
            chat.messages.push({role:'user', content:txt + (img?" [G√∂rsel]":"")});
            if(chat.messages.length===1 && txt) { chat.title = txt.substring(0,25); UIManager.renderSidebar(); }

            State.isTyping = true; document.getElementById('sendBtn').style.opacity = "0.5";
            const aiMsgBubble = UIManager.createAiBubble();
            try {
                const res = await APIManager.generate(chat.messages.slice(0,-1), txt, img);
                await UIManager.typeWriter(aiMsgBubble, res);
                chat.messages.push({role:'ai', content:res}); ChatManager.save();
            } catch(e) { aiMsgBubble.innerHTML = "‚ö†Ô∏è Hata: " + e.message; } finally { State.isTyping = false; document.getElementById('sendBtn').style.opacity = "1"; }
        },
        save: () => localStorage.setItem('keremai_v10_chats', JSON.stringify(State.chats)),
        setMode: (m, el) => { State.currentMode = m; document.querySelectorAll('.mode-opt').forEach(d=>d.classList.remove('active')); el.classList.add('active'); }
    };

    const UIManager = {
        openModal: () => document.getElementById('settingsModal').style.display = 'flex',
        closeModal: () => document.getElementById('settingsModal').style.display = 'none',
        renderSidebar: () => {
            const l = document.getElementById('historyList'); l.innerHTML = '';
            State.chats.forEach(c => {
                const d = document.createElement('div'); d.className = `h-item ${c.id===State.activeChatId?'active':''}`;
                d.onclick = () => { ChatManager.loadChat(c.id); if(window.innerWidth<=768) toggleSidebar(); };
                d.innerHTML = `<span class="h-title">${c.title}</span><div class="h-actions"><button class="action-btn" onclick="ChatManager.renameChat(event,${c.id})"><i class="fa-solid fa-pen"></i></button><button class="action-btn" onclick="ChatManager.deleteChat(event,${c.id})"><i class="fa-solid fa-trash"></i></button></div>`;
                l.appendChild(d);
            });
        },
        renderChat: (c) => {
            const a = document.getElementById('chatArea'); a.innerHTML = '';
            if(!c || c.messages.length===0) { a.innerHTML='<div style="text-align:center;margin-top:35vh;opacity:0.3;"><h3>KeremAI Hazƒ±r</h3></div>'; return; }
            c.messages.forEach(m => UIManager.appendMsg(m.role, m.content));
        },
        appendMsg: (role, txt, img=null) => {
            const d = document.createElement('div'); d.className = `msg ${role}`;
            const b = document.createElement('div'); b.className = 'bubble';
            if(role === 'user') { let h = txt; if(img) h += `<br><img src="${img}">`; b.innerHTML = h; } 
            else { b.innerHTML = marked.parse(txt); UIManager.addCopyButtons(b); }
            d.innerHTML = `<div class="avatar ${role}">${role==='ai'?'<i class="fa-solid fa-robot"></i>':'<i class="fa-solid fa-user"></i>'}</div>`; d.appendChild(b);
            const a = document.getElementById('chatArea'); a.appendChild(d); a.scrollTop = a.scrollHeight;
        },
        createAiBubble: () => {
            const d = document.createElement('div'); d.className = 'msg ai';
            const b = document.createElement('div'); b.className = 'bubble typing-cursor';
            d.innerHTML = `<div class="avatar ai"><i class="fa-solid fa-bolt"></i></div>`; d.appendChild(b);
            const a = document.getElementById('chatArea'); a.appendChild(d); a.scrollTop = a.scrollHeight;
            return b;
        },
        typeWriter: (el, txt) => {
            return new Promise((resolve) => {
                let i = 0; const speed = 10;
                const interval = setInterval(() => {
                    el.textContent += txt.charAt(i); i++; const a = document.getElementById('chatArea'); a.scrollTop = a.scrollHeight;
                    if (i >= txt.length) { clearInterval(interval); el.classList.remove('typing-cursor'); el.innerHTML = marked.parse(txt); UIManager.addCopyButtons(el); resolve(); }
                }, speed);
            });
        },
        addCopyButtons: (el) => {
            el.querySelectorAll('pre code').forEach(b => hljs.highlightElement(b));
            el.querySelectorAll('pre').forEach(pre => {
                if(pre.querySelector('.copy-btn')) return;
                const btn = document.createElement('button'); btn.className = 'copy-btn'; btn.innerHTML = '<i class="fa-regular fa-copy"></i> Kopyala';
                btn.onclick = () => { navigator.clipboard.writeText(pre.querySelector('code').innerText); btn.innerHTML = '<i class="fa-solid fa-check"></i>'; setTimeout(() => btn.innerHTML = '<i class="fa-regular fa-copy"></i> Kopyala', 2000); };
                pre.appendChild(btn);
            });
        }
    };
    
    // G√ºvenlik olduƒüu i√ßin window.onload'da ChatManager'ƒ± direkt ba≈ülatmƒ±yoruz.
    // ≈ûifre girilince ba≈ülatƒ±yoruz.
</script>
</body>
</html>
